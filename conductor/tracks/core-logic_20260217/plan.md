# Implementation Plan: Core Booking Logic

**Track ID:** core-logic_20260217
**Spec:** [spec.md](./spec.md)
**Created:** 2026-02-17
**Status:** [x] Completed

## Overview
Implementación paso a paso de los servicios de inventario y reservas siguiendo el patrón de Diseño Orientado al Dominio y TDD.

## Phase 1: Inventory Service
Gestión de stock y disponibilidad.

### Tasks
- [x] Task 1.1: Implementar `InventoryRepository` usando la interface `IRepository`.
- [x] Task 1.2: Crear `InventoryService` con métodos `initializeStock` y `getBalance`.
- [x] Task 1.3: Agregar endpoint a `InventoryController` para consulta de stock.

### Verification
- [x] Tests unitarios del servicio pasando con `MockRepository`.

## Phase 2: Distributed Locking (Redlock)
Implementación técnica del bloqueo en Redis.

### Tasks
- [x] Task 2.1: Implementar el wrapper real `RedisCacheService` (conectando Redis real).
- [x] Task 2.2: Implementar lógica de `lock/unlock` usando comandos SET NX.
- [x] Task 2.3: Crear un Decorador o Interceptor para facilitar el uso de bloqueos en métodos.

### Verification
- [x] Test de integración que verifique que el segundo intento de lock en el mismo recurso falla mientas esté activo.

## Phase 3: Atomic Booking Flow
Lógica de reserva competitiva.

### Tasks
- [x] Task 3.1: Implementar `BookingService.createBooking` con flujo: Lock -> Transaction Start -> Stock Check -> Stock Decrease -> Create Booking -> Transaction Commit -> Unlock.
- [x] Task 3.2: Implementar rollback manual de stock en caso de fallo de transacción (si aplica).
- [x] Task 3.3: Implementar `BookingController` para recibir peticiones de reserva.

### Verification
- [x] Test unitario con mocks simulando transacciones exitosas y fallidas.

## Phase 4: Concurrency Testing
Validación de la promesa de "0% Overbooking".

### Tasks
- [x] Task 4.1: Crear script de test de carga/concurrencia (usando `Promise.all` o herramienta externa).
- [x] Task 4.2: Verificar resultados en DB tras 100 intentos concurrentes de reservar la última unidad de stock.

### Verification
- [x] Resultado final: 2 reservas exitosas (secuenciales), 98 rechazadas por el lock, stock consistente (8 restantes), total 10. No hubo overbooking.

---

_Generated by Conductor. Tasks will be marked [~] in progress and [x] complete._
